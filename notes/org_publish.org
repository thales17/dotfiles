#+title: notes/orgpublish

<2022-04-27 Wed>
* Publish Script
- [[https://orgmode.org/worg/org-tutorials/org-publish-html-tutorial.html][Worg: Org Publish HTML Tutorial]]
* CSS
#+begin_src css :tangle ../css/main.css :mkdirp yes
.org-doc { color: blue; }
.org-keyword { color: red; }
.org-string { color: green; }
.org-variable-name { color: black; font-weight: bold; }
.org-function-name { color: mediumblue; }
.org-constant { color: purple; }
.org-comment { color: darkcyan; }
.org-type { color: orange; font-weight: bold; }
.org-warning { color: red; }
.timestamp { color: black; font-size: smaller; }
.timestamp { text-decoration: underline; }
.timestamp:before { content: "Last Updated: "; }

table {
    margin: auto;
}

body {
    color: black;
    background-color: #eff4f3;
    font-family:  "Liberation Sans", Helvetica, "Trebuchet MS", sans-serif;
    margin: auto;
    padding: 1em;
    max-width: 72em;
}

a {
    font-weight: bold;
    padding-right: .25em;
}

a:visited {
    color: black;
}

a:link {
    color: black;
}

#content > ul {
    list-style: none;
    padding: none;
}

ul {
    margin-top: 1em;
    padding-left: 1em;
}

li {
    margin-bottom: 1em;
}

nav {
    width: 100%;
    text-align: right;
    margin-bottom: 2em;
}

img {
    max-width: 100%;
}

#table-of-contents {
    display: none;
}

@media only screen and (min-width: 1200px) {
    body {
	font-size: 1.25em;
    }

    #table-of-contents {
	position: fixed;
	left: 0;
	top: 0;
	background-color: rgba(0, 0, 0, 0.8);
	color: white;
	font-size: 0.75em;
	padding: 1em;
	z-index: 1;
	display:flex;
	flex-direction: column;
    }

    #table-of-contents:hover, #table-of-contents:active {
	height: 100%;
    }

    #table-of-contents a:visited {
	color: white;
    }

    #table-of-contents a:link {
	color: white;
    }

    #text-table-of-contents {
	display: none;
    }

    #table-of-contents:hover #text-table-of-contents, #table-of-contents:active #text-table-of-contents {
	display: block;
	overflow-y: auto;
	flex: 1;
    }

}
#+end_src
* Straight.el
** Setup
#+begin_src elisp :tangle ../build-site.el
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
	(url-retrieve-synchronously
	 "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
	 'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

(setq straight-base-dir ".packages/")
#+end_src
** Packages
#+begin_src elisp :tangle ../build-site.el
(straight-use-package 'htmlize)
#+end_src

* Ox Publish
** Setup
*** Require Org Publish Features
#+begin_src elisp :tangle ../build-site.el
(require 'ox-publish)
#+end_src

*** Syntax Highlighting
- To get syntax highlighting for source code blocks I set the =htmlize= output type to CSS
#+begin_src elisp :tangle ../build-site.el
(setq org-html-htmlize-output-type 'css)
#+end_src

*** Link to Custom CSS
- I also create a head extra that includes the custom CSS
#+begin_src elisp :tangle ../build-site.el
(defvar ajr-html-head-extra "\n<link rel='stylesheet' href='/css/main.css' />\n")
#+end_src

*** Nav Bar HTML Generation
- Wrote a few functions that take a list of cons pairs and generate an html nav bar
- The first element in the cons pair is the URL the second is the title
#+begin_src elisp :tangle ../build-site.el
(defun ajr-nav (items)
  (let ((atags (apply #'concat
		      (mapcar
		       (lambda (item)
			 (concat "  "
				 (ajr-nav-item
				  (car item)
				  (cdr item))
				 "\n"))
		       items))))
    (concat
     "<nav>\n"
     atags
     "</nav>\n")))

(defun ajr-nav-item (url title)
  (concat
   "<a href=\"" url "\">" title "</a>"))
#+end_src

*** Nav Bar Items
- I created variables for each nav bar item so they can be reused across multiple navs
#+begin_src elisp :tangle ../build-site.el
(defvar ajr-nav-home
  '("/" . "Home"))

(defvar ajr-nav-dotfiles
  '("/dotfiles/README.html" . "Notes and Dotfiles"))

(defvar ajr-nav-about
  '("/about.html" . "About"))

#+end_src

*** Defining Preamble Variables
- The nav bars are going to be added to each page as =html-preamble=
- This section of code creates variables that represent different nav bars for different sections of the published site
#+begin_src elisp :tangle ../build-site.el
(defvar ajr-html-preamble
      (ajr-nav
       (list ajr-nav-home
	     ajr-nav-dotfiles
	     ajr-nav-about)))

(defvar ajr-html-top-preamble
      (ajr-nav
       (list ajr-nav-dotfiles
	     ajr-nav-about)))

#+end_src

** Publish Project alist
*** Posts
#+name: project-posts
#+begin_src elisp :tangle ../build-site.el
(list "org-site"
      :recursive t
      :base-directory "./"
      :exclude "dotfiles\\|about"
      :publishing-directory "./public"
      :auto-sitemap t
      :sitemap-title "Adam Richardson's Blog"
      :sitemap-sort-folders 'ignore
      :sitemap-sort-files 'anti-chronologically
      :sitemap-filename "index.org"
      :sitemap-format-entry (lambda (file-or-dir style project)
			      (if (equal file-or-dir "posts/")
				  "**Welcome to my personal blog**"
				(concat
				 (format-time-string
				  "%Y-%m-%d"
				  (org-publish-find-date
				   file-or-dir project))
				 ": [["
				 (concat "file:" file-or-dir)
				 "]["
				 (org-publish-find-title
				   file-or-dir project)
				 "]]")))
      :html-head-extra ajr-html-head-extra
      :html-preamble-format `(("en" ,ajr-html-preamble))
      :html-preamble t
      :html-postamble nil
      :html-validation-link nil
      :publishing-function 'org-html-publish-to-html)
#+end_src

*** Notes / Dotfiles
#+name: project-dotfiles
#+begin_src elisp :tangle ../build-site.el
(list "org-site"
      :recursive t
      :base-directory "./"
      :exclude "posts/"
      :publishing-directory "./public/"
      :html-head-extra ajr-html-head-extra
      :html-preamble-format `(("en" ,ajr-html-preamble))
      :html-preamble t
      :html-postamble nil
      :html-validation-link nil
      :publishing-function 'org-html-publish-to-html)
#+end_src

*** Top Level
#+name: project-top-level
#+begin_src elisp :tangle ../build-site.el
(list "org-site"
      :recursive nil
      :base-directory "./"
      :publishing-directory "./public/"
      :html-head-extra ajr-html-head-extra
      :html-preamble-format `(("en" ,ajr-html-top-preamble))
      :html-preamble t
      :html-postamble nil
      :html-validation-link nil
      :publishing-function 'org-html-publish-to-html)
#+end_src

*** CSS
#+name: project-css
#+begin_src elisp :tangle ../build-site.el
(list "org-static"
      :recursive t
      :base-directory "./dotfiles/css"
      :base-extension "css"
      :publishing-directory "./public/css"
      :publishing-function 'org-publish-attachment)
#+end_src

*** Assets
#+name: project-assets
#+begin_src elisp :tangle ../build-site.el
(list "org-static"
      :recursive t
      :base-directory "./"
      :base-extension "png\\|gif\\|jpg\\|jpeg\\|svg\\|webm\\|webp"
      :publishing-directory "./public/"
      :publishing-function 'org-publish-attachment)
#+end_src

*** Static HTML
#+name: project-static-html
#+begin_src elisp :tangle ../build-site.el
(list "org-static"
      :recursive t
      :base-directory "./static-html"
      :base-extension "html\\|js"
      :publishing-directory "./public/static-html"
      :publishing-function 'org-publish-attachment)
#+end_src
*** Project alist                                                  :noexport:
#+begin_src elisp :tangle ../build-site.el :noweb yes
(setq org-publish-project-alist
      (list
       <<project-posts>>
       <<project-dotfiles>>
       <<project-top-level>>
       <<project-css>>
       <<project-assets>>
       <<project-static-html>>))
#+end_src

** Actually Publishing
#+begin_src elisp :tangle ../build-site.el
(org-publish-all t)

(message "Build Complete")
#+end_src
