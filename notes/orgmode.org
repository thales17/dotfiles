#+title: notes/orgmode
#+exclude_tags: noexport
<2022-04-21 Thu>
* Plotting Data
- You need =gnuplot= and the =gnuplot= emacs package installed
- To plot the below example table from the manual use =C-c " g=
- This will open gnuplot and bring up an interactive graph
#+PLOT: title:"Citas" ind:1 deps:(3) type:2d with:histograms set:"yrange [0:]" :file plot.png
| Sede      | Max cites | H-index |
|-----------+-----------+---------|
| Chile     |    257.72 |   21.39 |
| Leeds     |    165.77 |   19.68 |
| Sao Paolo |     71.00 |   11.50 |
| Stockholm |    134.19 |   14.33 |
| Morelia   |    257.56 |   17.67 |
* Using Babel to Export Plots
- [[https://www.orgmode.org/worg/org-contrib/babel/languages/ob-doc-gnuplot.html][Worg: Org-babel-gnuplot]]
- Before this will work you need to enable =gnuplot= in the =org-babel-load-languages= variable

#+tblname: data-table
| x | y1 | y2 |
|---+----+----|
| 0 |  3 |  6 |
| 1 |  4 |  7 |
| 2 |  5 |  8 |
| 3 |  3 |  6 |
| 4 |  4 |  7 |
| 5 |  5 |  8 |

#+begin_src gnuplot :exports both :var data=data-table :file example_plot.png
set title "Example Org Babel Plot"
set xlabel "X Axis"
set ylabel "Y Axis"
plot data using 1:2 with lp lw 2 title 'Series 1', \
     data using 1:3 with lp lw 2 title 'Series 2'
#+end_src
#+RESULTS:
[[file:example_plot.png]]
* Editing the Structure
- =C-c C->= can be used to demote (add more stars) to an entire subtree
- Similarly =C-c C-<= can be use to promote an entire subtree
* Publishing
- This section walks through how this org repository is published into an html site
** CSS
#+begin_src css :tangle ../css/main.css :mkdirp yes
.org-doc { color: blue; }
.org-keyword { color: red; }
.org-string { color: green; }
.org-variable-name { color: black; font-weight: bold; }
.org-function-name { color: mediumblue; }
.org-constant { color: purple; }
.org-comment { color: darkcyan; }
.org-type { color: orange; font-weight: bold; }
.org-warning { color: red; }
.timestamp { color: black; font-size: smaller; }
.timestamp { text-decoration: underline; }
.timestamp:before { content: "Last Updated: "; }

table {
    margin: auto;
}

body {
    color: black;
    background-color: #eff4f3;
    font-family:  "Liberation Sans", Helvetica, "Trebuchet MS", sans-serif;
    margin: auto;
    padding: 1em;
    max-width: 72em;
}

a {
    font-weight: bold;
    padding-right: .25em;
}

a:visited {
    color: black;
}

a:link {
    color: black;
}

#content > ul {
    list-style: none;
}

ul {
    margin-top: 1em;
}

li {
    margin-bottom: 1em;
}

nav {
    width: 100%;
    text-align: right;
    margin-bottom: 2em;
}


@media only screen and (min-width: 1008px) {
    body {
	font-size: 1.25em;
    }
}
#+end_src

** Publish Script
- [[https://orgmode.org/worg/org-tutorials/org-publish-html-tutorial.html][Worg: Org Publish HTML Tutorial]]
*** Straight.el
**** Setup
#+begin_src elisp :tangle ../build-site.el
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
	(url-retrieve-synchronously
	 "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
	 'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

(setq straight-base-dir ".packages/")
#+end_src
**** Packages
#+begin_src elisp :tangle ../build-site.el
(straight-use-package 'htmlize)
#+end_src

*** Ox Publish
**** Setup
***** Require Org Publish Features
#+begin_src elisp :tangle ../build-site.el
(require 'ox-publish)
#+end_src

***** Syntax Highlighting
- To get syntax highlighting for source code blocks I set the =htmlize= output type to CSS
#+begin_src elisp :tangle ../build-site.el
(setq org-html-htmlize-output-type 'css)
#+end_src

***** Link to Custom CSS
- I also create a head extra that includes the custom CSS
#+begin_src elisp :tangle ../build-site.el
(defvar ajr-html-head-extra "\n<link rel='stylesheet' href='/css/main.css' />\n")
#+end_src

***** Nav Bar HTML Generation
- Wrote a few functions that take a list of cons pairs and generate an html nav bar
- The first element in the cons pair is the URL the second is the title
#+begin_src elisp :tangle ../build-site.el
(defun ajr-nav (items)
  (let ((atags (apply #'concat
		      (mapcar
		       (lambda (item)
			 (concat "  "
				 (ajr-nav-item
				  (car item)
				  (cdr item))
				 "\n"))
		       items))))
    (concat
     "<nav>\n"
     atags
     "</nav>\n")))

(defun ajr-nav-item (url title)
  (concat
   "<a href=\"" url "\">" title "</a>"))
#+end_src

***** Nav Bar Items
- I created variables for each nav bar item so they can be reused across multiple navs
#+begin_src elisp :tangle ../build-site.el
(defvar ajr-nav-home
  '("/" . "Home"))

(defvar ajr-nav-dotfiles
  '("/dotfiles/README.html" . "Notes and Dotfiles"))

(defvar ajr-nav-about
  '("/about" . "About"))

#+end_src

***** Defining Preamble Variables
- The nav bars are going to be added to each page as =html-preamble=
- This section of code creates variables that represent different nav bars for different sections of the published site
#+begin_src elisp :tangle ../build-site.el
(defvar ajr-html-preamble
      (ajr-nav
       (list ajr-nav-home
	     ajr-nav-dotfiles
	     ajr-nav-about)))

(defvar ajr-html-top-preamble
      (ajr-nav
       (list ajr-nav-dotfiles
	     ajr-nav-about)))

#+end_src

**** Publish Project alist
***** Posts
#+name: project-posts
#+begin_src elisp :tangle ../build-site.el
(list "org-site"
      :recursive t
      :base-directory "./"
      :exclude "dotfiles\\|about"
      :publishing-directory "./public"
      :auto-sitemap t
      :sitemap-title "Adam Richardson's Blog"
      :sitemap-sort-folders 'ignore
      :sitemap-sort-files 'anti-chronologically
      :sitemap-filename "index.org"
      :sitemap-format-entry (lambda (file-or-dir style project)
			      (if (equal file-or-dir "posts/")
				  "**Welcome to my personal blog**"
				(concat "[["
					(concat "file:" file-or-dir)
					"]["
					(concat
					 (format-time-string
					  "%Y-%m-%d"
					  (org-publish-find-date
					   file-or-dir project))
					 " - "
					 (org-publish-find-title
					  file-or-dir project))
					"]]")))
      :html-head-extra ajr-html-head-extra
      :html-preamble-format `(("en" ,ajr-html-preamble))
      :html-preamble t
      :html-postamble nil
      :html-validation-link nil
      :publishing-function 'org-html-publish-to-html)
#+end_src

***** Notes / Dotfiles
#+name: project-dotfiles
#+begin_src elisp :tangle ../build-site.el
(list "org-site"
      :recursive t
      :base-directory "./"
      :exclude "posts/"
      :publishing-directory "./public/"
      :html-head-extra ajr-html-head-extra
      :html-preamble-format `(("en" ,ajr-html-preamble))
      :html-preamble t
      :html-postamble nil
      :html-validation-link nil
      :publishing-function 'org-html-publish-to-html)
#+end_src

***** Top Level
#+name: project-top-level
#+begin_src elisp :tangle ../build-site.el
(list "org-site"
      :recursive nil
      :base-directory "./"
      :publishing-directory "./public/"
      :html-head-extra ajr-html-head-extra
      :html-preamble-format `(("en" ,ajr-html-top-preamble))
      :html-preamble t
      :html-postamble nil
      :html-validation-link nil
      :publishing-function 'org-html-publish-to-html)
#+end_src

***** CSS
#+name: project-css
#+begin_src elisp :tangle ../build-site.el
(list "org-static"
      :recursive t
      :base-directory "./dotfiles/css"
      :base-extension "css"
      :publishing-directory "./public/css"
      :publishing-function 'org-publish-attachment)
#+end_src

***** Assets
#+name: project-assets
#+begin_src elisp :tangle ../build-site.el
(list "org-static"
      :recursive t
      :base-directory "./assets"
      :base-extension "png\\|gif\\|jpg\\|jpeg\\|svg"
      :publishing-directory "./public/assets"
      :publishing-function 'org-publish-attachment)
#+end_src

***** Static HTML
#+name: project-static-html
#+begin_src elisp :tangle ../build-site.el
(list "org-static"
      :recursive t
      :base-directory "./static-html"
      :base-extension "html\\|js"
      :publishing-directory "./public/static-html"
      :publishing-function 'org-publish-attachment)
#+end_src
***** Project alist                                                :noexport:
#+begin_src elisp :tangle ../build-site.el :noweb yes
(setq org-publish-project-alist
      (list
       <<project-posts>>
       <<project-dotfiles>>
       <<project-top-level>>
       <<project-css>>
       <<project-assets>>
       <<project-static-html>>))
#+end_src

**** Actually Publishing
#+begin_src elisp :tangle ../build-site.el
(org-publish-all t)

(message "Build Complete")
#+end_src
** Appearance
*** Pretty Entities
- You can toggle pretty entities with =org-toggle-pretty-entites=
- This will render ordinals and exponents using superscripts
  - If enabled these should have superscripts, 1^{st} and x^{y}
  - This is an example of superscript syntax, =x^{3}=
* Graphviz
- [[https://www.orgmode.org/worg/org-contrib/babel/languages/ob-doc-dot.html][Worg: Dot Source Code Blocks in Org Mode]]
- [[https://www.graphviz.org/doc/info/lang.html][Grapviz DOT Language Documentation]]
- [[https://renenyffenegger.ch/notes/tools/Graphviz/examples/index][Rene Nyffenegger: Graphviz Examples]]
- Graphviz is a tool that compiles graph descriptions in the =dot= language into images
- Org mode ships with =dot= language support, it just needs to be enabled with =org-babel-load-languages=
- For an emacs major mode that supports graphviz use [[https://github.com/ppareit/graphviz-dot-mode][graphviz-dot-mode]]
- Graphviz has a new layout engines: dot, neato, fdp etc.
- To set the layout engine use =:cmd <LAYOUT_ENGINE>= in the header args of a graphviz, for example =:cmd neato= will use the neato layout engine
- The differences between the layouts is documented [[http://graphviz.org/docs/layouts/][here]].
#+begin_src dot :cmd neato :file example_graphviz.png :exports both
  digraph {
      a->b;
      b->c;
      c->b;
      c->a;
  }
#+end_src

#+RESULTS:
[[file:example_graphviz.png]]
* LaTex
- To view the Embedded LaTex section of the manual execute:
#+begin_src elisp
(info "(org) Embedded LaTex")
#+end_src
- [[https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-LaTeX.html][Worg: LaTex Source Code Blocks in Org Mode]]
- [[https://www.gnu.org/software/auctex/][AucTeX]] is an Emacs major mode for editing LaTex
- You will need a texlive distribution (like =texlive-most= on Arch Linux) installed on your system to access the LaTex programs
- In order to export to SVG you need to have =inkscape= installed on your computer
- Ensure that LaTex is added to the =org-babel-load-languages=
** Hello World
#+name: hello-world
#+BEGIN_SRC latex :exports both :file hello-latex.svg :buffer no
  (a + b)^2 = a^2 +2ab + b^2
#+END_SRC
[[file:hello-latex.svg]]
** TikZ
- [[https://www.homepages.ucl.ac.uk/~ucahjde/blog/tikz.html][TikZ and org-mode]]
* PlantUML
** Setup
- [[https://plantuml.com/emacs][PlantUML: Integration with Emacs]]
- Install the =plantuml-mode= package from MELPA
  - With =straight.el= ~(straight-use-package 'plantuml-mode)~
- Download the latest PlantUML jar file from the [[https://github.com/plantuml/plantuml/releases][Github releases]] page
- Save it to a known location, for example =~/jars/plantuml-1.2022.1.jar=
- Set the emacs variable =org-plantuml-jar-path= to the location of the jar file
#+begin_src elisp
(setq org-plantuml-jar-path
      (expand-file-name "~/jars/plantuml-1.2022.1.jar"))
#+end_src
- Enable =plantuml= in the =org-babel-load-languages=
** Example
- The example diagram was borrowed from: [[https://github.com/mattjhayes/PlantUML-Examples/blob/master/docs/Diagram-Types/source/class-diagram.md][Github mattjhayes: PlantUML Examples]]

#+begin_src plantuml :file plantuml_example.png :exports both
@startuml
skinparam shadowing false

title Class Diagram Example

skinparam class {
    BackgroundColor #94de5e
    ArrowColor #darkblue
    BorderColor black
}

class Vehicle {
	speed
    direction
	make
    model
	run()
}
class Car {
    driver_name
    road
	run()
}
class Plane {
    pilot_name
    altitude
	run()
}
class Ship {
    captain_name
    ocean
	run()
}
Vehicle <|-- Car
Vehicle <|-- Plane : inherits
Vehicle <|-- Ship

legend
    <size:18>Key</size>
    |<#94de5e> Class |
endlegend
@enduml
#+end_src

#+RESULTS:
[[file:plantuml_example.png]]
** Database Example
- [[https://raphael-leger.medium.com/automatically-generating-up-to-date-database-diagrams-with-typeorm-d1279a20545e][Raphael Leger: SQL + PlantUML: Generate Automatic Database Diagrams]]
#+begin_src plantuml :file plantuml_sql_example.png :exports both
@startuml
!define primary_key(x) <b><color:#b8861b><&key></color> x</b>
!define foreign_key(x) <color:#aaaaaa><&key></color> x
!define column(x) <color:#efefef><&media-record></color> x
!define table(x) entity x << (T, white) >>

left to right direction
skinparam roundcorner 5
skinparam linetype ortho
skinparam shadowing false
skinparam handwritten false
skinparam class {
    BackgroundColor white
    ArrowColor #2688d4
    BorderColor #2688d4
}

table( user ) {
  primary_key( id ): UUID
  column( isActive ): BOOLEAN
  foreign_key( cityId ): INTEGER <<FK>>
}

table( city ) {
  primary_key( id ): UUID
  column( name ): CHARACTER VARYING
  column( country ): CHARACTER VARYING
  column( postCode ): INTEGER
}

user }|--|| city

@enduml
#+end_src

#+RESULTS:
[[file:plantuml_sql_example.png]]
